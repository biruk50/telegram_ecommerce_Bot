#install requests
import io
from datetime import datetime
import logging
import json
import requests
from telegram import Bot,InputFile
from typing import Final
import database
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes,ConversationHandler,MessageHandler,filters,CallbackContext

TOKEN: Final = '6342676141:AAGP1LeG5aLkFaXTHOwPFaFtLtf1wCk4ZaQ'
BOt_USERNAME : Final = '@Addis_market_bot'
bot = Bot(TOKEN)
print('Starting up bot...')

# Enable logging
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
# set higher logging level for httpx to avoid all GET and POST requests being logged
logging.getLogger("httpx").setLevel(logging.WARNING)

logger = logging.getLogger(__name__)



aNSWER_1, aNSWER_2, aNSWER_3, aNSWER_4, aNSWER_5= range(5)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
    "üéâ **Welcome to Addis Market!** üéâ\n"
    "·ä•·äï·ä≥·äï ·ãà·ã∞ ·ä†·ã≤·àµ ·åà·â†·ã´ ·â†·ã∞·àÖ·äì ·àò·å°\n\n"
    "üõçÔ∏è This is the bot where you can buy products other people post.\n"
    "·ã≠·àÖ ·àå·àé·âΩ ·à∞·ãé·âΩ ·ã®·àö·àà·å•·çâ·âµ·äï ·àù·à≠·â∂·âΩ·äï ·ã®·àö·åà·ãô·â†·âµ ·â¶·â≥ ·äê·ãç.\n\n"
    "üì¶ If you are looking to sell products, go to @beta_market_bot\n"
    "üì¶ ·àù·à≠·â∂·âΩ·äï ·àà·àò·à∏·å• ·ä®·çà·àà·åâ, @beta_market_bot ·ã≠·åé·â•·äô\n\n\n"
    "üîç Add the type of product you want to buy.\nFor example: phone, house, shoes, laptop, car.\n\n"
    "üîç ·àà·àò·åç·ãõ·âµ ·ã®·àö·çà·àç·åâ·âµ ·ã®·àù·à≠·âµ ·ä†·ã≠·äê·âµ ·ä†·àµ·åà·â°.\n"
    "·àà·àù·à≥·àå ·ç°- ·àµ·àç·ä≠·ç£ ·â§·âµ ·ç£ ·å´·àõ·ç£ ·àã·çï·â∂·çï ·ç£ ·àò·ä™·äì"
)    
    return aNSWER_1

async def ANSWER_1(update: Update, context: ContextTypes.DEFAULT_TYPE)-> int:
    product_type_supply = update.message.text.lower()
    if product_type_supply =='/cancel':
        await update.message.reply_text('Conversation cancelled')
        return ConversationHandler.END
    else:
        context.user_data['product_type_supply'] = product_type_supply
        await update.message.reply_text(f'üí∞ Add the maximum price for your product in birrs.\nExample:- 550, 2000, 1000000.\n please make sure you input only a number do not include birr\n\n '
                                        f'üí∞ ·àù·à≠·â± ·ä®·àù·äï·ã´·àÇ·àç ·ãã·åã ·àõ·äê·àµ ·ä•·äï·ã≥·àã·â†·âµ ·â†·â•·à≠ ·ã´·àµ·åà·â°·ç¢\n·àà·àù·à≥·àå·ç°- 550, 2000, 1000000.\n ·ä•·â£·ä≠·ãé·äï ·âÅ·å•·à≠ ·â•·âª ·àõ·àµ·åà·â£·âµ·ãé·äï ·ã´·à®·åã·åç·å° ·â•·à≠ ·ã®·àù·àà·ãä·äï ·âÉ·àç ·ä†·ã´·ä´·âµ·â±.')
    return aNSWER_2

async def ANSWER_2(update: Update, context: ContextTypes.DEFAULT_TYPE)-> int:
    if update.message.text.lower() == '/cancel':
        await update.message.reply_text('Conversation cancelled')
        return ConversationHandler.END
    else:
        try:
            max_price= float(update.message.text)
            context.user_data['max_price'] = max_price
        except ValueError:
            await update.message.reply_text(f'‚ö†Ô∏èInvalid response. Please enter a number.\nüí∞Add the maximum price for your product in birrs.\nExample:- 550, 2000, 1000000.\n please make sure you input only a number do not include birr\n\n '
                                            f'‚ö†Ô∏è·àù·à≠·â± ·ä®·àù·äï·ã´·àÇ·àç ·ãã·åã ·àõ·äê·àµ ·ä•·äï·ã≥·àã·â†·âµ ·â†·â•·à≠ ·ã´·àµ·åà·â°·ç¢\n·àà·àù·à≥·àå·ç°- 550, 2000, 1000000.\nüí∞ ·ä•·â£·ä≠·ãé·äï ·âÅ·å•·à≠ ·â•·âª ·àõ·àµ·åà·â£·âµ·ãé·äï ·ã´·à®·åã·åç·å° ·â•·à≠ ·ã®·àù·àà·ãä·äï ·âÉ·àç ·ä†·ã´·ä´·âµ·â±.')
            return aNSWER_2
    await update.message.reply_text(f'üí∞Add the minimum price for your product in birrs.\nExample:- 450, 2000, 1000000.\n please make sure you input only a number do not include birr\n\n'
                                        f'üí∞·àù·à≠·â± ·ä®·àù·äï·ã´·àÇ·àç ·ãã·åã ·àò·â°·àà·âµ ·ä•·äï·ã≥·àã·â†·âµ ·â†·â•·à≠ ·ã´·àµ·åà·â°·ç¢\n·àà·àù·à≥·àå·ç°- 450, 2000, 1000000.\n ·ä•·â£·ä≠·ãé·äï ·âÅ·å•·à≠ ·â•·âª ·àõ·àµ·åà·â£·âµ·ãé·äï ·ã´·à®·åã·åç·å° ·â•·à≠ ·ã®·àù·àà·ãä·äï ·âÉ·àç ·ä†·ã´·ä´·âµ·â±.')
    return aNSWER_3

async def ANSWER_3(update: Update, context: ContextTypes.DEFAULT_TYPE)-> int:
    if update.message.text.lower() == '/cancel':
        await update.message.reply_text('Conversation cancelled')
        return ConversationHandler.END
    else:
        try:
            min_price = float(update.message.text)
            context.user_data['min_price'] = min_price
        except ValueError:
            await update.message.reply_text(f'‚ö†Ô∏èInvalid response. Please enter a number.\nüí∞Add the minimum price for your product in birrs.\nExample:- 450, 2000, 1000000.\n please make sure you input only a number do not include birr\n\n'
                                            f'‚ö†Ô∏è·àç·ä≠ ·ã´·àç·àÜ·äê ·àù·àã·àΩ ·äê·ãç ·ã≠·àµ·åà·â°·âµ ·ä•·â£·ä≠·ãé·äï ·âÅ·å•·à≠ ·ã≠·àµ·åà·â£·ç¢\nüí∞·àù·à≠·â± ·ä®·àù·äï·ã´·àÇ·àç ·ãã·åã ·àò·â°·àà·âµ ·ä•·äï·ã≥·àã·â†·âµ ·â†·â•·à≠ ·ã´·àµ·åà·â°·ç¢\n·àà·àù·à≥·àå·ç°- 450, 2000, 1000000.\n ·ä•·â£·ä≠·ãé·äï ·âÅ·å•·à≠ ·â•·âª ·àõ·àµ·åà·â£·âµ·ãé·äï ·ã´·à®·åã·åç·å° ·â•·à≠ ·ã®·àù·àà·ãä·äï ·âÉ·àç ·ä†·ã´·ä´·âµ·â±.')
            return aNSWER_3
    await update.message.reply_text(f'üîµPlease input only one of this 3 states of you want for your product.\nStates:- brand new, slightly used, used\n\n'
                                    f'üîµ·àà·àù·à≠·âµ·ãé ·ä®·àö·çà·àç·åâ·âµ 3 ·ã≠·ãò·â∂·âΩ ·ãç·àµ·å• ·ä†·äï·ã±·äï ·â•·âª ·ã´·àµ·åà·â°·ç¢\n·ã≠·ãò·â∂·âΩ- ·ä†·ã≤·àµ·ç£ ·âµ·äï·àΩ ·å•·âÖ·àù ·àã·ã≠ ·ã®·ãã·àà·ç£ ·å•·âÖ·àù ·àã·ã≠ ·ã®·ãã·àà')
    return aNSWER_4

async def ANSWER_4(update: Update,context: ContextTypes.DEFAULT_TYPE)-> int:
    status_supply = update.message.text.lower()
    if status_supply =='/cancel':
        await update.message.reply_text('Conversation cancelled')
        return ConversationHandler.END
    else:
        status_supply = update.message.text.lower()
        context.user_data['status_supply'] = status_supply
        await update.message.reply_text(f'üìù Add a description of the product.\nThis can include the specific model of the product.\nExample:- iphone 8 , nike ,adidas, specific laptop type.\n\n'
                                        f'üìù ·ã®·àù·à≠·â±·äï ·àò·åç·àà·å´ ·ã´·ä≠·àâ·ç¢\n·ã≠·àÖ ·ã®·àù·à≠·â±·äï ·àç·ã© ·àû·ã¥·àç ·àä·ã´·ä´·âµ·âµ ·ã≠·âΩ·àã·àç·ç¢\n·àà·àù·à≥·àå·ç°- iphone 8·ç£ nike·ç£adidas·ç¢')
    
    return aNSWER_5
    
async def ANSWER_5(update: Update, context: ContextTypes.DEFAULT_TYPE)-> int:
    description_supply = update.message.text.lower()
    if description_supply=='/cancel':
        await update.message.reply_text('Conversation cancelled')
        return ConversationHandler.END
    else:
        context.user_data['description_supply'] = description_supply
        user_name = update.message.from_user.username
        context.user_data['user_name'] = user_name
        current_date = datetime.now()
        date = current_date.strftime('%m-%d-%Y')
        context.user_data['date'] = date
    
    
        product_type_supply = context.user_data['product_type_supply']
        max_price = context.user_data['max_price']
        min_price = context.user_data['min_price']  
        status_supply = context.user_data['status_supply']
        description_supply = context.user_data['description_supply']
        user_name = '@'+context.user_data['user_name']
        date = context.user_data['date']
    
        database.insert_supply(product_type_supply,max_price,min_price,status_supply,description_supply,user_name,date)
    
        records = database.query(product_type_supply,max_price,min_price,status_supply,description_supply )
        if len(records)==0:
            await update.message.reply_text(f'sorry there are no items with your specific needs.\n type /start again then try changing your price range\n\n'
                                            f'·ã≠·âÖ·à≠·â≥ ·ä®·çç·àã·åé·â∂·âΩ·àÖ ·åã·à≠ ·àù·äï·àù ·ä†·ã≠·äê·âµ ·ä•·âÉ·ãé·âΩ ·ä†·àç·â∞·åà·äò·àù.\n ·ä•·äï·ã∞·åà·äì /start ·â•·àà·ãç ·ã≠·åÄ·àù·à≠ ·ä®·ãõ ·ã®·ãã·åã ·ä≠·àç·àé·äï ·àà·àò·âÄ·ã®·à≠ ·ã≠·àû·ä≠·à©')
        else:
            for record in records:
                if record[7] != None:
                    photo_json1_string= record[7]
                    photo_json1_dict = json.loads(photo_json1_string)
                    url1= photo_json1_dict['file_path']
                    response = requests.get(url1)
                    photo1 = InputFile(io.BytesIO(response.content), filename='file_1.jpg')
                
                if record[8] != None:
                    photo_json2_string =record[8]
                    photo_json2_dict = json.loads(photo_json1_string)
                    url2 = photo_json2_dict['file_path']
                    response = requests.get(url2)
                    photo2 = InputFile(io.BytesIO(response.content), filename='file_2.jpg')
                if record[9] != None:
                    photo_json3_string= record[9]
                    photo_json3_dict = json.loads(photo_json3_string)
                    url3= photo_json3_dict['file_path']
                    response = requests.get(url3)
                    photo3 = InputFile(io.BytesIO(response.content), filename='file_3.jpg')
                await update.message.reply_text(f'Product type ={record[1]}\nPrice = {record[2]}birrs\nSellers telegram username = {record[3]}\nPhone number = {record[4]}\nProduct status = {record[5]}\nProduct Description = {record[6]}')
                if record[7] != None:
                    await bot.send_photo(chat_id=update.message.chat_id, photo=photo1)
                if record[8] != None:
                    await bot.send_photo(chat_id=update.message.chat_id, photo=photo2)
                if record[9] != None:
                    await bot.send_photo(chat_id=update.message.chat_id, photo=photo3)
    await update.message.reply_text(f'See you soon.\nIf you have an feedback on how we can improve tell us on our channel at https://t.me/Addis_Market_channel \nand our group at https://t.me/Addis_Market_Group')
    return ConversationHandler.END

async def cancel(update, context):
    await update.message.reply_text('Conversation cancelled')
    return ConversationHandler.END

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Displays info on how to use the bot."""
    await update.message.reply_text("Use /start to test this bot.")


def main()-> None:
    # Create the Application and pass it your bot's token.
    application = Application.builder().token(TOKEN).build()

    #application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    
    conv_handler_2 = ConversationHandler(
    entry_points=[CommandHandler("start", start)],
    states={
        aNSWER_1: [MessageHandler(filters.TEXT, ANSWER_1)],
        aNSWER_2: [MessageHandler(filters.TEXT, ANSWER_2)],
        aNSWER_3: [MessageHandler(filters.TEXT, ANSWER_3)],
        aNSWER_4: [MessageHandler(filters.TEXT, ANSWER_4)],
        aNSWER_5: [MessageHandler(filters.TEXT, ANSWER_5)],
    },
    fallbacks=[CommandHandler('cancel', cancel)],

)
    application.add_handler(conv_handler_2)
    
    # Run the bot until the user presses Ctrl-C
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()

    #app.run_polling(poll_interval=5)
